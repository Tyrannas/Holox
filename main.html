<!doctype html>
<style>
.blue {
    background-color: rgb(96, 148, 245);
    border-radius: 5px;
    padding: 3px;
}
.green {
    background-color: rgb(163, 245, 96);
    border-radius: 5px;
    padding: 3px;
}
.node-data {
    text-align: center;
    color: #a50000
}

.node-name {
    text-align: center;
}
.node {
    /* font-size: 0.1em; */
}
</style>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title></title>
    <!-- stylesheets -->
    <link rel="stylesheet" href="treant-js-master/Treant.css" type="text/css"/>
    <style>
        .button{
            padding: 0.7em
        }
        .button:hover{
            cursor: pointer
        }
    </style>
</head>
<body>
    <div style="margin: auto;display: block; width: 40%;">
        <input type="text" id="userInput" style="width: 80%" value="Toto,Lapin."/>
        <input type=button onclick="parseInput()" value="GO">
    </div>
    <div style="margin: auto;display: block; width: 40%; margin-top: 1em;">
        <div style="margin: auto; width: 60%;">
            <input type=button class="button" onclick="first()" value="<<">
            <input type=button class="button" onclick="previous()" value="<">
            <input type=button class="button" onclick="play()" value="Play">
            <input type=button class="button" onclick="pause()" value="Pause">
            <input type=button class="button" onclick="next()" value=">">
            <input type=button class="button" onclick="last()" value=">>">
        </div>
    </div>
    <p id="input" style="text-align: center;"></p>
    <div id="tree-simple"> </div>
    <!-- javascript -->
    <script src="treant-js-master/vendor/raphael.js"></script>
    <script src="treant-js-master/Treant.js"></script>
    <!-- <script src="parser.js"></script> -->
    <script src="lexer.js"></script>
    <script src="conf.js"></script>
    <script src="utils.js"></script>
    <script src="ParserTree.js"></script>
    <script src="GrammarParser.js"></script>

    <script>
        var simple_chart_config;
        var all_trees = []
        var current_tree = 0
        var playing = false
        var terminals = []
        async function parseInput(){
            // simple_chart_config = {
            //     chart: {
            //         container: "#tree-simple"
            //     },
                
            //     nodeStructure: {
            //         text: { name: "Root"},
            //         HTMLclass: "blue"
            //     }
            // };
            var input = document.getElementById('userInput').value
            var tokens = scan(tokenizer, input)//.map(el => el.type)
            let parser = new GrammarParser(grammar)
            let t1 = new Date().getTime()
            // console.log(tokens)

            // parse(tokens, "texte", simple_chart_config.nodeStructure, grammar)

            parser.parse(tokens, "texte")

            console.log("computed in " +( new Date().getTime() - t1) / 1000 + "s")
            // removeUselessBranches(simple_chart_config.nodeStructure)
            // last()

            let treant_config = {
                chart: {
                    container: "#tree-simple"
                },
                
                nodeStructure: parser.getTree().toTreantTree()
            }
            // console.log(parser.getTree())
            new Treant(treant_config)

        }
        
        function drawTree(){
            if(DEBUG){
                simple_chart_config.nodeStructure = JSON.parse(all_trees[current_tree]);
            }
            if(current_tree == all_trees.length -1 || !DEBUG) {
                removeUselessBranches(simple_chart_config.nodeStructure)
            }
            setLeafGreen(simple_chart_config.nodeStructure)
            new Treant(simple_chart_config)
        }
        function first(){
            current_tree = 0;
            drawTree()
        }
        function last(){
            current_tree = all_trees.length - 1;
            drawTree()
        }
        async function play(){
            playing = true
            while(current_tree < all_trees.length && playing){
                drawTree()
                current_tree++
                await sleep(DISPLAY_SPEED)
            }
        }
        function pause(){
            playing = false
        }
        function next(){
            if(current_tree < all_trees.length - 1){
                current_tree++
            }
            drawTree()
        }
        function previous(){
            if(current_tree !== 0){
                current_tree--
            }
            drawTree()
        }

        function buildGrammar(grammarRules) {
            grammar = {}
            rules = grammarRules.split(';')
            rules.pop()
            rules.forEach(r => { 
                let parsed = r.split(':=')
                let tokens = parsed[1].split('|').map(tok => tok.trim().split(' '))
                grammar[parsed[0].trim()] = tokens
            })
            return grammar
        }
        (async function () {
            const respGram = await fetch(HOST + "/" + GRAMMAR)
            const grammarRules = await respGram.text()
            
            const respLexems = await fetch(HOST + "/" + LEXEMS)
            const lexerRules = await respLexems.text()
            
            var tokenizer = buildTokenizer(lexerRules);
            var grammar = buildGrammar(grammarRules);
            terminals = Object.keys(tokenizer)
        })();
        
        </script>
</body>
</html>